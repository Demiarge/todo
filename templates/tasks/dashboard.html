{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard – Task Manager{% endblock %}
{% block content %}

<!-- Header -->
<div class="header-actions">
  <h1 class="page-title" style="margin: 0;">Dashboard</h1>
  <a href="{% url 'tasks:task_create' %}" class="btn btn-primary">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    New Task
  </a>
</div>

<!-- Stats & Chart Card -->
<div class="card">
  <div class="header-overview">
    <h2 style="margin: 0; font-size: 1.25rem;">Overview</h2>
    <button id="toggleChartBtn" class="btn btn-secondary btn-sm">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
        <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
      </svg>
      View Chart
    </button>
  </div>

  <!-- JSON Data for Chart -->
  <script type="application/json" id="chartData">
    {
      "total": {{ total_tasks }},
      "completed": {{ completed_count }},
      "pending": {{ pending_count }},
      "in_progress": {{ in_progress_count }},
      "overdue": {{ overdue_tasks|length }}
    }
  </script>

  <!-- Percentage View -->
  <div id="percentageView" class="stats-grid">
    <div class="stat-card">
      <span class="stat-label">Total Tasks</span>
      <span class="stat-value">{{ total_tasks }}</span>
    </div>
    <div class="stat-card progress">
      <span class="stat-label">In Progress</span>
      <span class="stat-value">{{ in_progress_count }}</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Pending</span>
      <span class="stat-value">{{ pending_count }}</span>
    </div>
    <div class="stat-card complete">
      <span class="stat-label">Completed</span>
      <span class="stat-value">{{ completed_count }}</span>
    </div>

    <!-- Weekly Completion Rate -->
    <div class="completion-rate-container">
      <div class="completion-rate-row">
        <div style="flex: 1;">
          <small class="stat-label" style="display: block; margin-bottom: 0.5rem;">Weekly Completion Rate</small>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" style="width: {{ completion_percentage }}%;"></div>
          </div>
        </div>
        <span class="stat-value" style="font-size: 1.5rem;">{{ completion_percentage }}%</span>
      </div>
    </div>
  </div>

  <!-- Chart View -->
  <div id="chartContainer" class="chart-container">
    <canvas id="tasksChart"></canvas>
  </div>
</div>

<!-- Filter Form -->
<form method="get" action="{% url 'tasks:dashboard' %}" class="card filter-form">
  <input type="text" name="q" value="{{ search }}" placeholder="Search tasks..." class="search-input">

  <select name="status" class="filter-select">
    <option value="">All Statuses</option>
    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
  </select>

  <select name="priority" class="filter-select">
    <option value="">All Priorities</option>
    <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
    <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
    <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
  </select>

  <button type="submit" class="btn btn-secondary">Filter</button>
</form>

<!-- Task Lists -->
<div class="task-grid-section">
  <!-- My Tasks -->
  <div>
    <h2 style="margin-bottom: 1rem;">My Tasks</h2>
    {% for task in created_tasks %}
    <div class="card task-item task-item-content">
      <div class="task-header">
        <span class="badge badge-{{ task.priority }}">{{ task.get_priority_display }}</span>
        <span class="badge badge-{{ task.status }}">{{ task.get_status_display }}</span>
      </div>
      <h3 style="margin: 0 0 0.5rem;">
        <a href="{% url 'tasks:task_detail' task.slug %}" class="task-title-link stretched-link">{{ task.title }}</a>
      </h3>
      {% if task.is_overdue %}
      <div class="badge badge-high" style="margin-top: 0.5rem;">Overdue</div>
      {% endif %}
    </div>
    {% empty %}
    <div class="card" style="text-align: center; color: var(--text-muted);">No tasks found.</div>
    {% endfor %}
  </div>

  <!-- Assigned Tasks -->
  <div>
    <h2 style="margin-bottom: 1rem;">Assigned to Me</h2>
    {% for task in assigned_tasks %}
    <div class="card task-item task-item-content">
      <div class="task-header">
        <span class="badge badge-{{ task.priority }}">{{ task.get_priority_display }}</span>
        <span class="badge badge-{{ task.status }}">{{ task.get_status_display }}</span>
      </div>
      <h3 style="margin: 0 0 0.5rem;">
        <a href="{% url 'tasks:task_detail' task.slug %}" class="task-title-link stretched-link">{{ task.title }}</a>
      </h3>
      <small class="task-meta">
        By {{ task.creator.username }}
        {% if task.due_date %} • Due {{ task.due_date }}{% endif %}
      </small>
    </div>
    {% empty %}
    <div class="card" style="text-align: center; color: var(--text-muted);">No assigned tasks.</div>
    {% endfor %}
  </div>
</div>

<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}